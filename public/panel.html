<!DOCTYPE html>
<html>
<head>

    <link rel="stylesheet" type="text/css" media="screen" href="style.css" />

    <title>Panel</title>
</head>
<body>

    <div id="poruka"></div>
    <div id="porukaHub"></div>

    <div id="divKat"></div>
    <div id="divMeni"></div>

    <div>
        <table class='tabela grid3'>
            <tr><th>ID</th><th>Kat</th><th>Naziv</th><th>Cena</th></tr>
        </table>

    </div>

    <div>
        <label for="stoBR">stoBR:</label>
        <input id="stoBR" type="number" value="13" />

        <h2>Ukupno:</h2>
        <h1 id="ukupno">0.00</h1>
        <button id="naruci">Naruci</button>
    </div>

    <hr />


    <!--Script references. -->
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Ako radimo sa .html stranicom mora se ukljuciti sledecom linijom: -->
    <script src="./Scripts/jquery-1.10.2.js"></script>
    <!--Reference the SignalR library. -->
    <script src="./Scripts/jquery.signalR-2.4.1.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="./signalr/hubs"></script>

    <script>

        $(function () {
            // Reference the auto-generated proxy for the hub.
            var conn = $.connection.adminHub;
            // Create a function that the hub can call back to display messages.
            conn.client.preuzmiMeni = function () {
                if ($('#KatBroj').text() == '0')
                    GetMeni();
                else
                    GetMeniKat($("#KatBroj").text());
            };

            // Start the connection.
            $.connection.hub.start()
                .done(function () {
                    $("#porukaHub").html("Konekcija na Hub:<br>" + $.connection.hub.id);
                })
                .fail(function () {
                    $("#porukaHub").html("Konekcija na Hub:<br>Nije uspela iz nkog razloga!");
                });
        });


        $(document).ready(function () {

            GetKat();
            GetMeni();


            $(document.body)
                .on("click", ".grid2 tr:not(:first-child)", function () {
                    var cena = $(this).children(':nth-child(4)').text();
                    var ukupno = (parseFloat($("#ukupno").text()) + parseFloat(cena)).toFixed(2);

                    $(this).clone().appendTo(".grid3");
                    $("#ukupno").text(ukupno);
                })

                .on("dblclick", ".grid3 tr:not(:first-child)", function () {
                    var cena = $(this).children(':nth-child(4)').text();
                    var ukupno = (parseFloat($("#ukupno").text()) - parseFloat(cena)).toFixed(2);

                    $(this).remove();
                    $("#ukupno").text(ukupno);
                })

                .on("click", ".grid1 tr:not(:first-child)", function () {
                    var kat = $(this).children(':nth-child(1)').text();
                    $("#KatBroj").text(kat);
                    GetMeniKat(kat);
                })

              .on("mouseover", ".tabela tr:not(:first-child)", function () {
                  $(this).css("background-color", "yellow");
              })

              .on("mouseout", ".tabela tr:not(:first-child)", function () {
                  $(this).css("background-color", "");
              })

            .on("click", "#SveKat", function () {
                $("#KatBroj").text('0');
                GetMeni();
            }); // $(document.body) - end


            $("#naruci").click(function () {
                racunPostID();
            })


        }); // $(document).ready - end


        function racunPostID() {
            var racun = {
                stoBR: $('#stoBR').val(),
                iznos: $("#ukupno").text()
            };

            $.ajax({
                url: './api/racuni/',
                type: 'POST',
                data: JSON.stringify(racun),
                contentType: "application/json;charset=utf-8",
                success: function (LastRacunID) {
                    $("#poruka").text('Racun je uspesno upisan.');
                    UpisStavkiRacuna(LastRacunID);
                },
                error: function () {
                    $("#poruka").text('Greska! Racun nije upisan.');
                }
            });

            function UpisStavkiRacuna(LastRnID) {
                //Loop through the Table rows and build a JSON array.
                var stavkeRN = new Array();
                $(".grid3 tr:not(:first-child)").each(function () {
                    var row = $(this);
                    var stavka = {};

                    stavka.racunID = LastRnID;
                    stavka.meniID = row.find("td").eq(0).html();
                    stavkeRN.push(stavka);
                    
                });

                $.ajax({
                    type: "POST",
                    url: "./api/stavkeRN",
                    data: JSON.stringify(stavkeRN),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (data) {
                        $("#poruka").append(' Broj upisanih stavki: ' + data);
                        $("#ukupno").text('0.00');
                        $(".grid3").html('<tr><th>ID</th><th>Kat</th><th>Naziv</th><th>Cena</th></tr>');
                        $("#stoBR").val(Math.floor(Math.random() * 100) + 1);
                    },
                    error: function () {
                        $("#poruka").text('Greska! Stavke racuna nisu upisane.');
                    }
                });
            }
        }


        function GetMeni() {
            $.ajax({
                url: './api/meni',
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    WriteResponses(data);
                    $("#poruka").text("</br>Uspesno su ocitani svi podaci iz menia.");
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    $("#poruka").text('</br>Greska! Meni nije ucitan. ' + jqXHR.status + " - " + errorThrown);
                }
            });

            function WriteResponses(stavkeMenia) {
                var strResult = "<table class='tabela grid2'><tr><th>ID</th><th>Kat</th><th>Naziv</th><th>Cena</th></tr>";
                $.each(stavkeMenia, function (index, meni) {
                    strResult += "<tr><td>" + meni.ID + "</td><td> " + meni.Kat + "</td><td>" + meni.Naziv + "</td><td>" + meni.Cena.toFixed(2) + "</td></tr>";
                });

                strResult += "</table>";
                $("#divMeni").html(strResult);
            }
        }

        function GetMeniKat(kat) {
            $.ajax({
                url: './api/kategorije/' + kat,
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    WriteResponses(data);
                },
                error: function (x, y, z) {
                    $("#poruka").text(x + '\n' + y + '\n' + z);
                }
            });

            function WriteResponses(stavkeMenia) {
                var strResult = "<table class='tabela grid2'><tr><th>ID</th><th>Kat</th><th>Naziv</th><th>Cena</th></tr>";
                $.each(stavkeMenia, function (index, meni) {
                    strResult += "<tr><td>" + meni.ID + "</td><td> " + meni.Kat + "</td><td>" + meni.Naziv + "</td><td>" + meni.Cena.toFixed(2) + "</td></tr>";
                });

                strResult += "</table>";

                $("#divMeni").html(strResult);
            }
        }


        function GetKat() {
            $.ajax({
                url: './api/kategorije',
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    tabelaKat(data);
                },
                error: function (x, y, z) {
                    $("#poruka").text(x + '\n' + y + '\n' + z);
                }
            });

            function tabelaKat(stavkeKat) {
                var strResult = "<table class='tabela grid1'><tr><th>katBR</th><th>katNaziv</th></tr>";
                $.each(stavkeKat, function (index, kat) {
                    strResult += "<tr><td>" + kat.katBR + "</td><td> " + kat.katNaziv + "</td></tr>";
                });

                strResult += "</table>";
                $("#divKat").html(strResult);
                $("#divKat").append("<span id='KatBroj'>0</span>");
                $("#divKat").append("<button id='SveKat'>SveKat</button>");
            }
        }

    </script>




</body>
</html>
