<!DOCTYPE html>
<html>
<head>
    <script src="./Scripts/jquery-1.10.2.js"></script>
    <!--Reference the SignalR library. -->
    <script src="./Scripts/jquery.signalR-2.4.1.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="./signalr/hubs"></script>

    <link rel="stylesheet" type="text/css" media="screen" href="style.css" />

    <title>Administrator</title>
</head>
<body>

    <div id="poruka"></div>
    <div id="porukaHub"></div>

    <div>
        <div id="divKat"></div>
        <div id="divKatKomande">
            <span id='KatBroj'>0</span>
            <button id='SveKat'>SveKat</button>

            <label for="katBr">KatBR</label>
            <input id="katBr" type="number" />

            <label for="katNazuv">KatNaziv</label>
            <input id="katNazuv" type="text" />
            <br />
            <button id="dodajKat" onclick="dodajKat()">Dodaj</button>
            <button id="brisiKat" onclick="brisiKat()">Brisi</button>
        </div>
    </div>
    <div id="divMeni"></div>

    <div>
        <label for="meniID">ID</label>
        <input id="meniID" type="number" />

        <label for="meniKat">Kat</label>
        <input id="meniKat" type="number" />

        <label for="meniNaziv">Naziv</label>
        <input id="meniNaziv" type="text" />

        <label for="meniCena">Cena</label>
        <input id="meniCena" type="text" />

        <br />
        <button id="meniGetID" onclick="meniGetID()">Get</button>
        <button id="meniDeleteID" class="promenaMenia">Delete</button>
        <br />
        <button id="meniPostID" class="promenaMenia">Add</button>
        <button id="meniPutID" class="promenaMenia">Update</button>
    </div>

    <hr />

    <script>

        //$(function () {
            // Reference the auto-generated proxy for the hub.
            var conn = $.connection.adminHub;
            // Create a function that the hub can call back to display messages.
            conn.client.preuzmiMeni = function () {
                if ($('#KatBroj').text() == '0')
                    GetMeni();
                else
                    GetMeniKat($("#KatBroj").text());
            };

            // Start the connection.
            $.connection.hub.start()
                .done(function () {
                    $("#porukaHub").html("Konekcija na Hub:<br>" + $.connection.hub.id);

                    /*$('.promenaMenia').click(function () {
                        // Call the promeniMeni method on the hub.
                        setTimeout(function () { // mora odlozeno da bi sacekao promene u bazi
                            conn.server.promeniMeni();
                        }, 200);
                    });*/
                })
                .fail(function () {
                    $("#porukaHub").html("Konekcija na Hub:<br>Nije uspela iz nkog razloga!");
                });
        //});

            

        $(document).ready(function () {

            GetKat();
            GetMeni();


            $(document.body)
              .on("click", ".grid2 tr:not(:first-child)", function () {
                  var id = $(this).children(':nth-child(1)').text();
                  var kat = $(this).children(':nth-child(2)').text();
                  var naziv = $(this).children(':nth-child(3)').text();
                  var cena = $(this).children(':nth-child(4)').text();
                  $("#meniID").val(id);
                  $("#meniKat").val(parseInt(kat));
                  $("#meniNaziv").val(naziv);
                  $("#meniCena").val(cena);
                  $("#poruka").text('Klik na tabelu Menia ne koristi bazu.');

              })

                .on("click", ".grid1 tr:not(:first-child)", function () {
                    var kat = $(this).children(':nth-child(1)').text();
                    var katNaziv = $(this).children(':nth-child(2)').text();
                    $("#KatBroj").text(kat);
                    $("#katBr").val(kat);
                    $("#katNazuv").val(katNaziv);
                    
                    GetMeniKat(kat);

                })

              .on("mouseover", ".tabela tr:not(:first-child)", function () {
                  $(this).css("background-color", "yellow");
              })

              .on("mouseout", ".tabela tr:not(:first-child)", function () {
                  $(this).css("background-color", "");
              })

            .on("click", "#SveKat", function () {
                $("#poruka").text('Sve kategorije: ');
                $("#KatBroj").text('0');
                $("#katBr").val('');
                $("#katNazuv").val('');
                GetMeni();
            });

        });  // $(document).ready - end


        function GetMeniKat(kat) {
            $.ajax({
                url: './api/kategorije/' + kat,
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    $("#poruka").text('Uspesno su ocitane stavke menia iz kategorije: ' + kat);
                    WriteResponses(data);
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    $("#poruka").text('Greska! ' + jqXHR.status + " - " + errorThrown);
                }
            });

            function WriteResponses(stavkeMenia) {
                var strResult = "<table class='tabela grid2'><tr><th>ID</th><th>Kat</th><th>Naziv</th><th>Cena</th></tr>";
                $.each(stavkeMenia, function (index, meni) {
                    strResult += "<tr><td>" + meni.ID + "</td><td> " + meni.Kat + "</td><td>" + meni.Naziv + "</td><td>" + meni.Cena.toFixed(2) + "</td></tr>";
                });

                strResult += "</table>";

                $("#divMeni").html(strResult);
            }
        }

        function GetMeni() {
            $.ajax({
                url: './api/meni',
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    WriteResponses(data);
                    $("#poruka").append("</br>Uspesno su ocitani svi podaci iz menia.");
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    $("#poruka").text('</br>Greska! Meni nije ucitan. ' + jqXHR.status + " - " + errorThrown);
                }
            });

            //Displays in a Table
            function WriteResponses(stavkeMenia) {
                var strResult = "<table class='tabela grid2'><tr><th>ID</th><th>Kat</th><th>Naziv</th><th>Cena</th></tr>";
                $.each(stavkeMenia, function (index, meni) {
                    strResult += "<tr><td>" + meni.ID + "</td><td> " + meni.Kat + "</td><td>" + meni.Naziv + "</td><td>" + meni.Cena.toFixed(2) + "</td></tr>";
                });

                strResult += "</table>";
                $("#divMeni").html(strResult);
            }
        }

        function meniGetID() {
            $.ajax({
                url: './api/meni/' + $('#meniID').val(),
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    $("#poruka").text('Get: Stavka ' + $('#meniID').val() + ' je uspesno ucitana.');
                    WriteResponse(data);
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    $("#poruka").text('Get: Greska! Stavka nije ucitana.' + jqXHR.status + " - " + errorThrown);
                }
            });

            function WriteResponse(meni) {
                $('#meniID').val(meni.ID);
                $('#meniKat').val(meni.Kat);
                $('#meniNaziv').val(meni.Naziv);
                $('#meniCena').val(meni.Cena);
            }
        }



        $('#meniDeleteID').click(function () {
            $.ajax({
                url: './api/meni/' + $('#meniID').val(),
                type: 'DELETE',
                dataType: 'json',
                success: function (data) {
                    $("#poruka").text('Delete: Stavka ' + data + ' je izbrisana.');
                    //GetMeni();
                    conn.server.promeniMeni();
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    $("#poruka").text('Delete: Greska! Trazena stavka nije izbrisana. ' + jqXHR.status + " - " + errorThrown);
                }
            });
        });


        $('#meniPostID').click(function () {
            var meni = {
                kat: $('#meniKat').val(),
                //id: $('#meniID').val(),
                naziv: $('#meniNaziv').val(),
                cena: $('#meniCena').val()
            };

            $.ajax({
                url: './api/meni/',
                type: 'POST',
                data: JSON.stringify(meni),
                contentType: "application/json;charset=utf-8",
                success: function (data) {
                    $("#poruka").text('Add: Stavka je uspesno dodata.');
                    //GetMeni();
                    conn.server.promeniMeni();
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    $("#poruka").text('Add: Greska! Stavka nije dodata. ' + jqXHR.status + " - " + errorThrown);
                }
            });
        });


        $('#meniPutID').click(function () {
            var meni = {
                kat: $('#meniKat').val(),
                id: $('#meniID').val(),
                naziv: $('#meniNaziv').val(),
                cena: $('#meniCena').val()
            };

            $.ajax({
                url: './api/meni/' + $('#meniID').val(),
                type: 'PUT',
                data: JSON.stringify(meni),
                contentType: "application/json;charset=utf-8",
                success: function (data) {
                    $("#poruka").text('Update: Stavka je uspesno promenjena.');
                    //GetMeni();
                    conn.server.promeniMeni();
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    $("#poruka").text('Update: Greska! Stavka nije promenjena. ' + jqXHR.status + " - " + errorThrown);
            }
            });
        });




        function GetKat() {
            $.ajax({
                url: './api/kategorije',
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    $("#poruka").append("Uspesno su ocitani svi podaci iz kategorija.");
                    tabelaKat(data);
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    $("#poruka").text('Greska! Kategorije nisu ucitane. ' + jqXHR.status + " - " + errorThrown);
                }
            });

            function tabelaKat(stavkeKat) {
                var strResult = "<table class='tabela grid1'><tr><th>katBR</th><th>katNaziv</th></tr>";
                $.each(stavkeKat, function (index, kat) {
                    strResult += "<tr><td>" + kat.katBR + "</td><td> " + kat.katNaziv + "</td></tr>";
                });

                strResult += "</table>";
                $("#divKat").html(strResult);
            }
        }

        function dodajKat() {
            var kat = {
                katBr: $('#katBr').val(),
                katNaziv: $('#katNazuv').val()
            };

            $.ajax({
                url: './api/kategorije/',
                type: 'POST',
                data: JSON.stringify(kat),
                contentType: "application/json;charset=utf-8",
                success: function (data) {
                    $("#poruka").text('Dodaj: Kategorija je uspesno dodata. => ');
                    GetKat();
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    $("#poruka").text('Dodaj: Greska! Kategorija nije dodata. ' + jqXHR.status + " - " + errorThrown);
                }
            });
        }

        function brisiKat() {
            if (confirm("Brisanje Kategorije!\nSve stavke Menia iz Kategorije ce takodje biti izbrisane!!!")) {
                $.ajax({
                    url: './api/kategorije/' + $('#katBr').val(),
                    type: 'DELETE',
                    dataType: 'json',
                    success: function (data) {
                        $("#poruka").text('Brisi: Kategorija ' + data + ' je izbrisana. => ');
                        GetKat();
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        $("#poruka").text('Brisi: Greska! Trazena Kategorija nije izbrisana. ' + jqXHR.status + " - " + errorThrown);
                    }
                });
            }
        }

    </script>




</body>
</html>
